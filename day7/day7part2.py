INPUT = """
......................................................................S......................................................................
.............................................................................................................................................
......................................................................^......................................................................
.............................................................................................................................................
.....................................................................^.^.....................................................................
.............................................................................................................................................
....................................................................^...^....................................................................
.............................................................................................................................................
...................................................................^.^.^.^...................................................................
.............................................................................................................................................
..................................................................^.^.^...^..................................................................
.............................................................................................................................................
.................................................................^.^.^.^.^.^.................................................................
.............................................................................................................................................
................................................................^.^.^.^.^...^................................................................
.............................................................................................................................................
...............................................................^.^.^...^.^.^.^...............................................................
.............................................................................................................................................
..............................................................^.^.^.^.^.^...^.^..............................................................
.............................................................................................................................................
.............................................................^.^.......^...^.^.^.............................................................
.............................................................................................................................................
............................................................^.^.^.^.^...^.^.^.^.^............................................................
.............................................................................................................................................
...........................................................^.^.^.^.^.^.^.^...^.^.^...........................................................
.............................................................................................................................................
..........................................................^.....^.^.^.^.......^.^.^..........................................................
.............................................................................................................................................
.........................................................^...^.^.^.^.^...^.^.^.....^.........................................................
.............................................................................................................................................
........................................................^.....^.^.....^.^.^.^.....^.^........................................................
.............................................................................................................................................
.......................................................^...^.^.^.......^...^...^.^.^.^.......................................................
.............................................................................................................................................
......................................................^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^......................................................
.............................................................................................................................................
.....................................................^.^.^.^...^...^...........^.^.^.^.^.....................................................
.............................................................................................................................................
....................................................^.^...^.^.....^.^...^.^.^.^.^...^...^....................................................
.............................................................................................................................................
...................................................^.^...^...^...^...^.^.^.^.^...^.^.^.^.^...................................................
.............................................................................................................................................
..................................................^.....^.^.....^.^.^.^.^.^...^.^.....^.^.^..................................................
.............................................................................................................................................
.................................................^.^.^...^.^.^.....^.^.^.^.^.....^.^.^...^.^.................................................
.............................................................................................................................................
................................................^...^...^...^.^.^.........^.^.^.^.^.^.......^................................................
.............................................................................................................................................
...............................................^.^.^.^...^.^.^.......^.^.........^.^.^.^.....^...............................................
.............................................................................................................................................
..............................................^.^.^...^.^.^.^.^.^...^.^.....^.......^.^.^...^.^..............................................
.............................................................................................................................................
.............................................^.^.^.^.^.^...^.^.^.....^.^.^.^.^.^.^.....^.^.^.^.^.............................................
.............................................................................................................................................
............................................^.^.^...^.^.^.^.^.^.^...^.^.^.^...^.^.^.^.^.^...^.^.^............................................
.............................................................................................................................................
...........................................^.^.^.^.^.^.^.^.^.^...^.^.............^.^.^.........^.^...........................................
.............................................................................................................................................
..........................................^.^.^.....^.^.^.^...^.^.^.^.^.^...^.^.^.^.^.^...^.^.^...^..........................................
.............................................................................................................................................
.........................................^.^...^.^.^.^.^.^.......^.^...^.^.^.^...^...^.^.^...^.^.^.^.........................................
.............................................................................................................................................
........................................^.^.^.^.^.^...^...^.^.^.....^.^.^...^.^.^.^.^.^...^.^.^...^.^........................................
.............................................................................................................................................
.......................................^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.......^...^.^...^.^.^...^.......................................
.............................................................................................................................................
......................................^.^.^.^...^.^...^.^.^.^.^.^.^.^.^.....^.^...^.^.....^.^.^...^...^......................................
.............................................................................................................................................
.....................................^.^.^.^.^.^.^.^...^.^.^...^.....^.^...^.^.^.^.....^.^...^...^.^.^.^.....................................
.............................................................................................................................................
....................................^...^.^.^.....^.^.^.^.^...^...^...^.^.^.^.^.^.^...^.^.^.^.^...^...^.^....................................
.............................................................................................................................................
...................................^...^...^...^.^.^.....^.^...^.^.^.^.^.....^.^.^.^.^.^.....^...^.^.^...^...................................
.............................................................................................................................................
..................................^.^.^.^.^...^.....^.....^.......^.^.....^.^...^...^.^.^...^.....^.^.^.^.^..................................
.............................................................................................................................................
.................................^.^.....^.^.^.^.......^.......^.^.^.^.^.^...^.^...^.^.^...^...^.^...^.....^.................................
.............................................................................................................................................
................................^.^.^.^.^...^.^.^...^.^.^.^.^.^.^.^...^.^.^.^.....^.^.^.....^.^.^.^...^.....^................................
.............................................................................................................................................
...............................^.^...^.^.^...^...^.^.....^.....^.^.^.^...^.....^...^...^...^.^.^.^.^.....^.^.^...............................
.............................................................................................................................................
..............................^.^.....^.^.^.^...^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.......^.^.^.....^...^...^.^..............................
.............................................................................................................................................
.............................^.^.^.^.........^.....^.^.^...^...^.^.^.^.^...^...^.^.^.^.^.^.^...^.^.^.^...^.^...^.............................
.............................................................................................................................................
............................^.^.^.^.^.^.^.^...^.^.....^.^...^.^.^.^.^.....^.^.^.^...^.^.^.^.^...^...^...^...^.^.^............................
.............................................................................................................................................
...........................^.^...^.^.^.^.^.^...^.^.^.....^...^.^.^.^.^...^...^.^...^.^.......^.^.^...^.^.^.^.^.^.^...........................
.............................................................................................................................................
..........................^.^...^.^.^.^.^.^.^.........^.^...^.^.^.^.^.^.^.......^.^.^...^.^...^...^.^.^.^.^...^.^.^..........................
.............................................................................................................................................
.........................^.....^.^.^.^.^.^...^.^.^.^.....^.^.^...^.^.....^.^.^.^.^.^...^...^.^.....^.^.....^.^.^.^.^.........................
.............................................................................................................................................
........................^...^...^.^.^.^.^.^.....^.^.^.^.^.^.^.^.^.^.....^.^...^...^...^.^.^.^.^.^.......^.^.^.^.^...^........................
.............................................................................................................................................
.......................^.^.^...^.^.......^.^.^.^.^.^...^.^.......^.^.^...^.^...^.^.^.^.^...^.^.^.^...^.^.^.^.^.^.^.^.^.......................
.............................................................................................................................................
......................^.^.^.^...^.^.^.^.^.^.^...^.......^.^...^...^...^...^...^...^.....^...^.^.^.^...^.^.^...^.^.^.^.^......................
.............................................................................................................................................
.....................^.^.^...^.^...^.^...^.....^...^.^.^.^.....^.^...^.^.^.^.....^...^.......^.^.^...^.....^.^.^.....^.^.....................
.............................................................................................................................................
....................^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.....^...^.^.^.^.^...^.^.^.^.^.^.^...^.^.......^...^.^.^.^.^.^.^.....^....................
.............................................................................................................................................
...................^.^.....^.....^...^.^...^...^...^.^.^...^.......^.^...^...^.^.^.^.^.^.^.^...^.^.^.^.^...^.^...^...^.^.^...................
.............................................................................................................................................
..................^...^.^.^.^.^.^.^.^.^.^.^.^.....^...^...^...^.^.^.^.^.^.^.^.^...^.....^...^...^.^.^.^.^.....^...^.^.^.^.^..................
.............................................................................................................................................
.................^.^.^.^.....^...^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.....^.^.^...^.^.^...^.......^.....^.^...^...^.......^.^.................
.............................................................................................................................................
................^.^...^.....^.^...^.^...^.^.^...^.^.^.^...^.^.^.^.....^.^...^.^...^.^...^.^.....^.^.^.....^.^.^.^.^.^...^...^................
.............................................................................................................................................
...............^.^.....^.^.^.^.^.^.^.^...^.^...^.^...^.^.^...^.^.....^.^...^.^.^.^.^.........^.^...^.^.^...^.^.^.....^...^.^.^...............
.............................................................................................................................................
..............^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.....^.^.^...^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.........^.^.^.^.^...^.^.^.^..............
.............................................................................................................................................
.............^.^.^.^.^.^...^.^.^.^...^.^.^.^.^.........^.^...^.^.^.....^.^...^.^.^...^.^.^...^.^...^...^...^...^.^.^.^.^.^...^.^.............
.............................................................................................................................................
............^.^.....^.^...^.^.^.^.......^.^.^.^.^.....^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.^...^.^.^...^.^...^.^.^...^.^.^.^.^.^.^...^............
.............................................................................................................................................
...........^.^.^...^.^.^.^.^...^...^.^.^.....^.^...^.^.^...^.^.^...^.^.^.^...^...^.^.....^...^.^.....^.^.^.^.^.^.^.^...^.......^.^...........
.............................................................................................................................................
..........^.^.^.^.^.^...^...^.^.^.^.^.^.....^.^.^.^.^...^...^.^.^...^.^.^.^.^...^.^.^.^.....^.^.^.^.^.^.^.^.^.^.^.....^.^.^.......^..........
.............................................................................................................................................
.........^.^.^.^.^...^.^...^...^.....^.^...^.^...^.^.^.^.^.^.........^.^.^.^.^...^.^.^...^.^.^.^.^...^.....^.^.^.^.^.^.^.^.^.^.^...^.........
.............................................................................................................................................
........^...^.....^.^.......^...^.^.^.^.....^.^.^.^.......^.^...^.^.^.^.^.^.^.^.^.^.^.....^...^.^.....^...^.^.^.^.^...^...^.....^.^.^........
.............................................................................................................................................
.......^.^.^.^.^.^...^.^.^...^.^...^...^.......^.^.^.^.^.^...^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.....^.^.^.^...^.^.^.......
.............................................................................................................................................
......^.^.^.^.......^.^.^.^.....^.^.^...^.^.^.^.^...^...^...^.^.^.........^.....^.^.^.^.^.^.....^.......^.^.......^.....^.^.^.^.^.....^......
.............................................................................................................................................
.....^.^.^.^.....^.^.^...^...^.......^.^...^.....^.^.^.^.^...^...^.^.^.^...^.^.^.^.^.^.^.^.^...^.......^...^.........^.^.^.^...^.^...^.^.....
.............................................................................................................................................
....^.^.^.^.^.^.^.^.^.^...^.^...^.^.^...^.^.^.^...^.^...^.^.^.^...^...^.^.^.^.^.^.^...^.^.^...^.......^.^.^.^.^.^.^.^.^.^.^.^...^.^.^...^....
.............................................................................................................................................
...^...^.^.^.^...^.^...^.^.....^.^.^.^.^.^.^.^.^.....^.^.^...^...^.^.^.^.^...^...^.^.^.^...^.^.^.^.^...^...^.^.^.^.^...^.^.^.^.....^.....^...
.............................................................................................................................................
..^.^...^...^.^.^.^...^.^.^...^.^.^.^.^.....^...^...^.^.^.....^.^.....^.^.^...^.....^.^...^.^.^.^...^.......^.^.....^.^.......^.^.......^.^..
.............................................................................................................................................
.^...^.^.^.^.^.^.....^.^.^.........^.^...^.^.^.^...^.^.^.^...^.^.........^.^...^.....^...^.^.^.^.^.^.^...^...^.^.^.........^.^.^.^.^.^.^.^.^.
.............................................................................................................................................
""".strip("\n")

from functools import lru_cache


def parse_input(s: str):
    grid = s.splitlines()
    H = len(grid)
    W = len(grid[0])

    start_row = start_col = None
    for r in range(H):
        for c in range(W):
            if grid[r][c] == "S":
                start_row, start_col = r, c
                break
        if start_row is not None:
            break

    return grid, H, W, start_row, start_col


def count_timelines(grid, H, W, sr, sc) -> int:
    @lru_cache(maxsize=None)
    def dfs(r: int, c: int) -> int:
        # If the particle has left the manifold, that's one complete timeline.
        if r >= H or c < 0 or c >= W:
            return 1

        cell = grid[r][c]

        if cell == "^":
            # Time splits: particle goes left in one timeline and right in another.
            return dfs(r, c - 1) + dfs(r, c + 1)
        else:
            # Empty or S: particle just moves down.
            return dfs(r + 1, c)

    return dfs(sr, sc)


def main():
    grid, H, W, sr, sc = parse_input(INPUT)
    total_timelines = count_timelines(grid, H, W, sr, sc)
    print("Total timelines (Part 2):", total_timelines)


if __name__ == "__main__":
    main()